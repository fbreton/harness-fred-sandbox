pipeline:
  projectIdentifier: Fred_SandBox
  orgIdentifier: SE_Sandbox
  tags: {}
  stages:
    - stage:
        name: DeployQA
        identifier: DeployQA
        description: ""
        type: Deployment
        spec:
          deploymentType: Kubernetes
          service:
            serviceRef: <+input>
            serviceInputs: <+input>
          environment:
            environmentRef: QAPayServ
            deployToAll: false
            infrastructureDefinitions:
              - identifier: QAGKE
          execution:
            steps:
              - step:
                  type: JiraCreate
                  name: Jira Create
                  identifier: JiraCreate
                  spec:
                    connectorRef: Fred_Jira
                    projectKey: HD
                    issueType: Story
                    fields:
                      - name: Description
                        value: Deployment to QA
                      - name: Summary
                        value: Ticket to track deployment of <+service.name>
                  timeout: 1d
              - step:
                  name: Rollout Deployment
                  identifier: rolloutDeployment
                  type: K8sRollingDeploy
                  timeout: 10m
                  spec:
                    skipDryRun: false
                    pruningEnabled: false
                  failureStrategies:
                    - onFailure:
                        errors:
                          - AllErrors
                        action:
                          type: StageRollback
              - step:
                  type: JiraUpdate
                  name: Jira Update QATest
                  identifier: JiraUpdate
                  spec:
                    connectorRef: Fred_Jira
                    issueKey: <+pipeline.stages.DeployQA.spec.execution.steps.JiraCreate.issue.key>
                    transitionTo:
                      transitionName: Ready For Testing
                      status: QA Test
                    fields:
                      - name: Description
                        value: In QA, waiting for Approval to go in Prod or rejection
                  timeout: 1d
            rollbackSteps:
              - step:
                  type: JiraUpdate
                  name: Jira Update failed
                  identifier: Jira_Update_falied
                  spec:
                    connectorRef: Fred_Jira
                    issueKey: " <+pipeline.stages.DeployQA.spec.execution.steps.JiraCreate.issue.key>"
                    transitionTo:
                      transitionName: Rejected
                      status: Rejected
                    fields:
                      - name: Summary
                        value: Deployment to QA failed
                  timeout: 1d
              - step:
                  name: Rollback Rollout Deployment
                  identifier: rollbackRolloutDeployment
                  type: K8sRollingRollback
                  timeout: 10m
                  spec:
                    pruningEnabled: false
        tags: {}
        failureStrategies:
          - onFailure:
              errors:
                - AllErrors
              action:
                type: StageRollback
    - stage:
        name: SecScan
        identifier: SecScan
        template:
          templateRef: Aqua_Scan
          versionLabel: v2
          templateInputs:
            type: SecurityTests
            variables:
              - name: fail_on_severity
                type: String
                value: CRITICAL
    - stage:
        name: Approval
        identifier: Jira_Approve
        description: ""
        type: Approval
        spec:
          execution:
            steps:
              - step:
                  type: JiraApproval
                  name: Jira Approval
                  identifier: JiraApproval
                  spec:
                    connectorRef: Fred_Jira
                    projectKey: HD
                    issueType: Story
                    issueKey: <+pipeline.stages.DeployQA.spec.execution.steps.JiraCreate.issue.key>
                    approvalCriteria:
                      type: KeyValues
                      spec:
                        matchAnyCondition: true
                        conditions:
                          - key: Status
                            operator: equals
                            value: Approved
                    rejectionCriteria:
                      type: KeyValues
                      spec:
                        matchAnyCondition: true
                        conditions:
                          - key: Status
                            operator: equals
                            value: Rejected
                  timeout: 1d
        tags: {}
    - parallel:
        - stage:
            name: RemoveQA
            identifier: removeqa
            description: ""
            type: Deployment
            spec:
              deploymentType: Kubernetes
              service:
                useFromStage:
                  stage: DeployQA
              environment:
                environmentRef: QAPayServ
                deployToAll: false
                infrastructureDefinitions:
                  - identifier: QAGKE
              execution:
                steps:
                  - step:
                      type: K8sDelete
                      name: RemoveQA
                      identifier: RemoveQA
                      spec:
                        deleteResources:
                          type: ReleaseName
                          spec:
                            deleteNamespace: false
                      timeout: 10m
                      failureStrategies: []
                rollbackSteps: []
            tags: {}
            failureStrategies:
              - onFailure:
                  errors:
                    - AllErrors
                  action:
                    type: StageRollback
            when:
              pipelineStatus: All
        - stage:
            name: DeployProd
            identifier: DeployProd
            description: ""
            type: Deployment
            spec:
              deploymentType: Kubernetes
              service:
                useFromStage:
                  stage: DeployQA
              environment:
                environmentRef: PRODPayserv
                deployToAll: false
                infrastructureDefinitions:
                  - identifier: PRODGKE
              execution:
                steps:
                  - step:
                      type: JiraUpdate
                      name: Jira Update InProgress
                      identifier: Jira_Update_1
                      spec:
                        connectorRef: Fred_Jira
                        issueKey: " <+pipeline.stages.DeployQA.spec.execution.steps.JiraCreate.issue.key>"
                        transitionTo:
                          transitionName: In Progress
                          status: In Progress
                        fields:
                          - name: Description
                            value: Deploying in Production
                      timeout: 1d
                  - step:
                      type: K8sCanaryDeploy
                      name: Canary Deployment_1
                      identifier: CanaryDeployment_1
                      spec:
                        skipDryRun: false
                        instanceSelection:
                          spec:
                            percentage: 50
                          type: Percentage
                      timeout: 10m
                  - step:
                      type: Verify
                      name: verify_dev
                      identifier: verify_dev
                      spec:
                        type: Canary
                        monitoredService:
                          type: Default
                          spec: {}
                        spec:
                          sensitivity: LOW
                          duration: 5m
                          deploymentTag: <+serviceConfig.artifacts.primary.tag>
                      timeout: 2h
                      failureStrategies:
                        - onFailure:
                            errors:
                              - Verification
                            action:
                              type: ManualIntervention
                              spec:
                                timeout: 2h
                                onTimeout:
                                  action:
                                    type: StageRollback
                        - onFailure:
                            errors:
                              - Unknown
                            action:
                              type: ManualIntervention
                              spec:
                                timeout: 2h
                                onTimeout:
                                  action:
                                    type: Ignore
                  - step:
                      type: K8sRollingDeploy
                      name: Rolling Deployment
                      identifier: RollingDeployment
                      spec:
                        skipDryRun: false
                        pruningEnabled: false
                      timeout: 10m
                      failureStrategies: []
                  - step:
                      type: K8sCanaryDelete
                      name: Canary Delete_1
                      identifier: CanaryDelete_1
                      spec: {}
                      timeout: 10m
                  - step:
                      type: JiraUpdate
                      name: Jira Update Done
                      identifier: Jira_Update_2
                      spec:
                        connectorRef: Fred_Jira
                        issueKey: " <+pipeline.stages.DeployQA.spec.execution.steps.JiraCreate.issue.key>"
                        transitionTo:
                          transitionName: Done
                          status: Done
                        fields: []
                      timeout: 1d
                rollbackSteps:
                  - step:
                      type: JiraUpdate
                      name: Jira Update Canceled
                      identifier: JiraUpdate
                      spec:
                        connectorRef: Fred_Jira
                        issueKey: " <+pipeline.stages.DeployQA.spec.execution.steps.JiraCreate.issue.key>"
                        transitionTo:
                          transitionName: Invalid
                          status: Invalid
                        fields:
                          - name: Summary
                            value: Deployment to Prod failed
                      timeout: 1d
                  - step:
                      type: K8sRollingRollback
                      name: Rolling Rollback
                      identifier: RollingRollback
                      spec: {}
            tags: {}
            failureStrategies:
              - onFailure:
                  errors:
                    - AllErrors
                  action:
                    type: StageRollback
  allowStageExecutions: true
  identifier: payment_service_CD
  name: payment service CD
